(function() {
    var fruits = [
        // üü£ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ (1.0%)
        { name: '–†–µ–∑–∏–Ω–æ–≤—ã–π —Ñ—Ä—É–∫—Ç (–ù–∏–∫–∞)', rarity: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', chance: 0.5, description: '–ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å —Ç–µ–ª–æ –∫–∞–∫ —Ä–µ–∑–∏–Ω—É.' },
        { name: '–§—Ä—É–∫—Ç –¢—å–º—ã', rarity: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', chance: 0.5, description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–µ–π –∏ —Ç—å–º–æ–π.' },

        // üî¥ –≠–ø–∏—á–µ—Å–∫–∏–µ (5.0%)
        { name: '–§—Ä—É–∫—Ç –ú–∞–≥–º—ã', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', chance: 1, description: '–°–æ–∑–¥–∞—ë—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∞–≤–æ–π.' },
        { name: '–§—Ä—É–∫—Ç –§–µ–Ω–∏–∫—Å–∞', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', chance: 1, description: '–í–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ –∏ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –æ–≥–Ω–µ–Ω–Ω–æ–º –æ–±–ª–∏–∫–µ.' },
        { name: '–§—Ä—É–∫—Ç –ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–π', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', chance: 1, description: '–í—ã–∑—ã–≤–∞–µ—Ç —Ä–∞–∑—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã–µ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è.' },
        { name: '–§—Ä—É–∫—Ç –ú–∞–º–æ–Ω—Ç–∞', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', chance: 1, description: '–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–æ–≥—É—á–µ–≥–æ –º–∞–º–æ–Ω—Ç–∞.' },
        { name: '–§—Ä—É–∫—Ç –ë—É–¥–¥—ã', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', chance: 1, description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–ª–∞ –∏ —Å–∏–ª–∞ –ë—É–¥–¥—ã.' },

        // üîµ –†–µ–¥–∫–∏–µ (15.0%)
        { name: '–°–≤–µ—Ç–æ–≤–æ–π —Ñ—Ä—É–∫—Ç', rarity: '–†–µ–¥–∫–∏–π', chance: 3, description: '–ü–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏–µ –∏ –∞—Ç–∞–∫–∏ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é —Å–≤–µ—Ç–∞.' },
        { name: '–ì—Ä–æ–∑–æ–≤–æ–π —Ñ—Ä—É–∫—Ç', rarity: '–†–µ–¥–∫–∏–π', chance: 3, description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–ª–Ω–∏—è–º–∏ –∏ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ–º.' },
        { name: '–û–≥–Ω–µ–Ω–Ω—ã–π —Ñ—Ä—É–∫—Ç', rarity: '–†–µ–¥–∫–∏–π', chance: 3, description: '–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –æ–≥–Ω—è.' },
        { name: '–§—Ä—É–∫—Ç –û–ø–µ—Ä–∞—Ü–∏–π', rarity: '–†–µ–¥–∫–∏–π', chance: 3, description: '–•–∏—Ä—É—Ä–≥–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —Ç–µ–ª–µ–∫–∏–Ω–µ–∑.' },
        { name: '–õ–µ–¥—è–Ω–æ–π —Ñ—Ä—É–∫—Ç', rarity: '–†–µ–¥–∫–∏–π', chance: 3, description: '–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª—å–¥–æ–º.' },

        // üü† –ù–µ–æ–±—ã—á–Ω—ã–µ (24.0%)
        { name: '–ü–ª–∞–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ñ—Ä—É–∫—Ç', rarity: '–ù–µ–æ–±—ã—á–Ω—ã–π', chance: 4, description: '–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–ª–∞–≤–∞—Ç—å –ø–æ–¥ –≤–æ–¥–æ–π –±–µ–∑ –ø—Ä–æ–±–ª–µ–º.' },
        { name: '–§—Ä—É–∫—Ç –¢–µ–Ω–µ–π', rarity: '–ù–µ–æ–±—ã—á–Ω—ã–π', chance: 4, description: '–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è —Ç–µ–Ω—è–º–∏ –∏ –∏—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ.' },
        { name: '–§—Ä—É–∫—Ç –†–∞–∑–¥–µ–ª–µ–Ω–∏—è', rarity: '–ù–µ–æ–±—ã—á–Ω—ã–π', chance: 4, description: '–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–ª–∞ –Ω–∞ —á–∞—Å—Ç–∏.' },
        { name: '–§—Ä—É–∫—Ç –ë–∏–∑–æ–Ω–∞', rarity: '–ù–µ–æ–±—ã—á–Ω—ã–π', chance: 4, description: '–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –º–æ—â–Ω–æ–≥–æ –±–∏–∑–æ–Ω–∞.' },
        { name: '–§—Ä—É–∫—Ç –ß–µ–ª–æ–≤–µ–∫–∞', rarity: '–ù–µ–æ–±—ã—á–Ω—ã–π', chance: 4, description: '–£–º –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞.' },
        { name: '–§—Ä—É–∫—Ç –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', rarity: '–ù–µ–æ–±—ã—á–Ω—ã–π', chance: 4, description: '–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π.' },

        // üü¢ –û–±—ã—á–Ω—ã–µ (55.0%)
        { name: '–ì–ª–∞–¥–∫–∏–π —Ñ—Ä—É–∫—Ç', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–î–µ–ª–∞–µ—Ç —Ç–µ–ª–æ –≥–ª–∞–¥–∫–∏–º –∏ —Å–∫–æ–ª—å–∑–∫–∏–º.' },
        { name: '–í–∑—Ä—ã–≤–Ω–æ–π —Ñ—Ä—É–∫—Ç', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–°–æ–∑–¥–∞—ë—Ç –≤–∑—Ä—ã–≤—ã –∏–∑ —Ç–µ–ª–∞.' },
        { name: '–§—Ä—É–∫—Ç –ë–æ–ª–æ—Ç–∞', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –±–æ–ª–æ—Ç–∏—Å—Ç–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç—å—é.' },
        { name: '–§—Ä—É–∫—Ç –¶–≤–µ—Ç–æ–≤', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–†–æ—Å—Ç –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ç–µ–Ω–∏—è–º–∏.' },
        { name: '–§—Ä—É–∫—Ç –õ–µ–∑–≤–∏–π', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–°–æ–∑–¥–∞–Ω–∏–µ –æ—Å—Ç—Ä—ã—Ö –ª–µ–∑–≤–∏–π –∏–∑ —Ç–µ–ª–∞.' },
        { name: '–§—Ä—É–∫—Ç –Ø–≥–æ–¥', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —è–≥–æ–¥.' },
        { name: '–§—Ä—É–∫—Ç –¢—è–∂–µ—Å—Ç–∏', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Å–∞ –∏ —Å–∏–ª—ã —É–¥–∞—Ä–∞.' },
        { name: '–§—Ä—É–∫—Ç –õ—ë–≥–∫–æ—Å—Ç–∏', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–õ—ë–≥–∫–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏–π.' },
        { name: '–§—Ä—É–∫—Ç –ú–µ—Ç–∞–ª–ª–∞', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ —Ç–µ–ª–∞ –≤ –º–µ—Ç–∞–ª–ª.' },
        { name: '–§—Ä—É–∫—Ç –ó–∞–º–µ–¥–ª–µ–Ω–∏—è', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ–∫—Ä—É–≥.' },
        { name: '–§—Ä—É–∫—Ç –í–∑–≥–ª—è–¥–∞', rarity: '–û–±—ã—á–Ω—ã–π', chance: 5, description: '–ü–∞—Ä–∞–ª–∏–∑—É—é—â–∏–π –≤–∑–≥–ª—è–¥.' },

        // ‚ö™ –ó–∞–±–∞–≤–Ω—ã–µ/—Å—Ç—Ä–∞–Ω–Ω—ã–µ (–¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ)
        { name: '–§—Ä—É–∫—Ç –ó–∞–º–∫–æ–≤', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–∫–∞–º–∏ –∏ –∫–ª—é—á–∞–º–∏.' },
        { name: '–§—Ä—É–∫—Ç –ñ–µ–≤–∞–Ω–∏—è', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–£—Å–∏–ª–µ–Ω–∏–µ —Å–∏–ª—ã —á–µ–ª—é—Å—Ç–µ–π.' },
        { name: '–§—Ä—É–∫—Ç –ò—Å–∫—É—Å—Å—Ç–≤–∞', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–°–æ–∑–¥–∞–Ω–∏–µ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–ª–ª—é–∑–∏–π.' },
        { name: '–§—Ä—É–∫—Ç –ì–æ—Ä–º–æ–Ω–æ–≤', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏—è –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º.' },
        { name: '–§—Ä—É–∫—Ç –ö–Ω–∏–≥', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–ß—Ç–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–Ω–∏–≥.' },
        { name: '–§—Ä—É–∫—Ç –ì–∞–∑–∞', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–∞–∑–∞–º–∏ –∏ –¥—ã–º–æ–º.' },
        { name: '–§—Ä—É–∫—Ç –£–¥–∞–ª–µ–Ω–∏—è', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.' },
        { name: '–§—Ä—É–∫—Ç –°–ª–∞–¥–æ—Å—Ç–µ–π', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–∞–¥–æ—Å—Ç–µ–π –∏ –∫–æ–Ω—Ñ–µ—Ç.' },
        { name: '–§—Ä—É–∫—Ç –ú–æ—á–∏', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ —Ç–µ–ª–∞ –≤ –∫–ª–µ–π–∫—É—é –º–∞—Å—Å—É.' },
        { name: '–§—Ä—É–∫—Ç –õ–µ–æ–ø–∞—Ä–¥–∞', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –ª–µ–æ–ø–∞—Ä–¥–∞.' },
        { name: '–§—Ä—É–∫—Ç –°–æ–±–∞–∫–∏', rarity: '–û–±—ã—á–Ω—ã–π', chance: 1, description: '–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –≤ —Å–æ–±–∞–∫—É.' },

        // ‚ú® –†–µ–¥—á–∞–π—à–∏–π (0.1%)
        { name: '–ì–∞—á–∏ –Ω–æ –ú–∏', rarity: '–†–µ–¥—á–∞–π—à–∏–π', chance: 0.1, description: '–î–∞—ë—Ç –≤–ª–∞–¥–µ–ª—å—Ü—É –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—É—é –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ —Ç–µ–ª–æ –∫–æ–∂–∞–Ω–Ω—ã–º–∏ —Ä–µ–º–Ω—è–º–∏.' }
    ];

    function getRandomFruit() {
        var totalChance = fruits.reduce(function(sum, f) { return sum + f.chance; }, 0);
        var random = Math.random() * totalChance;

        for (var i = 0; i < fruits.length; i++) {
            if (random < fruits[i].chance) {
                return fruits[i];
            }
            random -= fruits[i].chance;
        }

        return fruits[fruits.length - 1];
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ—Ä—É–∫—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    function saveFruitToServer(user_name, fruit) {
        try {
            var url = new java.net.URL("http://localhost:3000/saveFruit");
            var conn = url.openConnection();
            conn.setRequestMethod("POST");
            conn.setDoOutput(true);
            conn.setRequestProperty("Content-Type", "application/json");

            var json = JSON.stringify({
                user_name: user_name,
                item_name: fruit.name,
                item_count: 1,
                rarity: fruit.rarity
            });

            var outputStream = new java.io.OutputStreamWriter(conn.getOutputStream(), "UTF-8");
            outputStream.write(json);
            outputStream.flush();
            outputStream.close();

            var responseCode = conn.getResponseCode();
            if (responseCode !== 200) {
                var inputStream = conn.getErrorStream() || conn.getInputStream();
                var reader = new java.io.BufferedReader(new java.io.InputStreamReader(inputStream, "UTF-8"));
                var line;
                var response = '';
                while ((line = reader.readLine()) != null) {
                    response += line;
                }
                reader.close();
                $.consoleLn("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ—Ä—É–∫—Ç–∞: HTTP " + responseCode + " " + response);
            }
        } catch (e) {
            $.consoleLn("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä: " + e);
        }
    }

    $.bind('command', function(event) {
        var sender = event.getSender().toLowerCase(),
            command = event.getCommand();

        if ($.equalsIgnoreCase(command, '—Ñ—Ä—É–∫—Ç')) {
            var fruit = getRandomFruit();
            $.say('@' + sender + ', —Ç—ã –ø–æ–ª—É—á–∏–ª: ' +
                fruit.name + ' (' + fruit.rarity + ') üçá ‚Äî ' +
                fruit.description);

            saveFruitToServer(sender, fruit);
        }
    });

    $.bind('initReady', function() {
        $.registerChatCommand('./games/FruitDrop.js', '—Ñ—Ä—É–∫—Ç');
    });
})();
